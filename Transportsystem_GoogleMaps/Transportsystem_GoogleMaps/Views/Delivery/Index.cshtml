@using Transportsystem_GoogleMaps.Models
@model Transportsystem_GoogleMaps.ViewModels.NewDeliveryViewModel

@{
    ViewBag.Title = "Deliveries";
}
<style>
    #map {
        height: 400px;
        width: 100%;
    }
</style>

<body>
<h2>Delivery</h2>

<ul class="list-inline">
    <li>
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expande>
                Transport Method 
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                <li><a href="#" onclick="updateMap('DRIVING')">Driving</a></li>
                <li><a href="#"onclick="updateMap('WALKING')">Walking</a></li>
                <li><a href="#"onclick="updateMap('BICYCLING')">Bicycle</a></li>
            </ul>
        </div>
    </li>
    <li>
        
        <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                Driver
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                @foreach (var driver in Model.Drivers)
                {
                    <li><a href="#" onclick="getRoute('@driver.Name')">@driver.Name</a></li>
                }
            </ul>
        </div>
    </li>

    <li><button id="cluster" onclick="cluster()">Generate route</button></li>
    
    <li>
        <div class="container">
            <div class="row">
                <div class='col-sm-6'>
                    <div class="form-group">
                        <div class='input-group' id='datetimepicker1'>
                            <input type='text'  class="form-control"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                    </div>
                </div>
                <script>
                    $(document).ready(function () {
                        $('#datetimepicker1').datetimepicker({
                            viewMode: 'days',
                            format: 'YYYY/MM/DD'
                        });
                    });
                </script>
            </div>
        </div>
    </li>
</ul>

<div id="map"></div>
<p id="traveltime"></p>
<div id="directions"></div>

<div id="driverPackages"></div>

    


</body>

<script>
    var travelTime = 0;
    var travelDistance = 0;
    var selectedRoute = 0;
    var i = 0;
    var model;
    var wholeModel;
    var directionsService;
    var directionsDisplay;
    var transportMethod = "DRIVING";
    

    function updateMap(method) {

        
        transportMethod = method;
        document.getElementById('dropdownMenu1').innerHTML = transportMethod + ' <span class="caret"></span>';
        calculateAndDisplayRoute(directionsService, directionsDisplay);
    }

    function initMap() {
        directionsService = new google.maps.DirectionsService;
        directionsDisplay = new google.maps.DirectionsRenderer;
        wholeModel = @Html.Raw(Json.Encode(Model.TestDictionary));
        console.log(wholeModel);

        

        model = @Html.Raw(Json.Encode(new List<Package>(Model.TestDictionary[Model.Drivers[0].Name])));

        @*wholeModel = @Html.Raw(Json.Encode(Model.PackageClusters));*@

        var center = { lat: 59.261897775, lng: 15.30572069518922 };

        var map = new google.maps.Map(document.getElementById('map'),
            {
                zoom: 7,
                center: center
            });
        directionsDisplay.setMap(map);

        //for (var j = 0; j < wholeModel.length; j++) {
        //    new google.maps.Marker({
        //        position: { lat: wholeModel[j].CentroidPackage.Latitude, lng: wholeModel[j].CentroidPackage.Longitude },
        //        map: map
        //    });
        //}

        calculateAndDisplayRoute(directionsService, directionsDisplay);
    }

    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        var wayPts = [];
        for (var j = 0; j < model.length; j++) {
            wayPts.push({
                location: model[j].Destination.toString()
            });
        }
        directionsService.route({
                origin: { lat: 59.246396, lng: 15.137283 },
                destination: { lat: 59.246544, lng: 15.136656 },

                waypoints: wayPts,
                optimizeWaypoints: true,
                travelMode: transportMethod
            },
            function(response, status) {
                if (status === 'OK') {
                    directionsDisplay.setDirections(response);
                    getTotalTime(response);
                    //showSteps(response, markerArray, stepDisplay, map);
                } else {
                    window.alert('Directions request failed due to ' + status);
                }
            });
    }

    function showSteps(directionResult, markerArray, stepDisplay, map) {
        // For each step, place a marker, and add the text to the marker's infowindow.
        // Also attach the marker to an array so we can keep track of it and remove it
        // when calculating new routes.
        var myRoute = directionResult.routes[0].legs[0];
        for (var i = 0; i < myRoute.steps.length; i++) {
            //var marker = markerArray[i] = markerArray[i] || new google.maps.Marker;
            //marker.setMap(map);
            //marker.setPosition(myRoute.steps[i].start_location);
            //attachInstructionText(
            //    stepDisplay, marker, myRoute.steps[i].instructions, map);
            document.getElementById('directions').innerHTML += '<br>' + myRoute.steps[i].instructions;
        }
    }

    function getTotalTime(result) {
        travelTime = 0;
        var routeLegs = result.routes[0].legs;
        for (var leg = 0; leg < routeLegs.length; leg++) {
            travelTime += routeLegs[leg].duration.value;
            travelDistance += routeLegs[leg].distance.value;
        }
        travelDistance /= 1000;
        document.getElementById('traveltime').innerHTML = "Total travel time: ";
        (travelTime / 3600 >= 1)
            ? document.getElementById('traveltime').innerHTML += Math.floor(travelTime / 3600) + "h " + Math.round((travelTime - 3600 * (Math.floor(travelTime / 3600))) / 60) + "min"
            : document.getElementById('traveltime').innerHTML += Math.round(travelTime / 60) + "min";
        document.getElementById('traveltime').innerHTML += "<br> Total travel distance: " + travelDistance.toFixed(2) + "km";
    }

    function cluster() {

        
        var mydatetimepicker = $('#datetimepicker1').datetimepicker();
        var dtp = mydatetimepicker.data('DateTimePicker');
        //console.log(dtp.date());
        var myDotNetDate = dtp.date().toISOString();
        console.log(myDotNetDate);


        // console.log(document.getElementById('datetimepicker').innerHTML);
       
        $.ajax({
            url: '/api/DeliveryRoute/',
            type: 'POST',
            contentType: 'application/json;',
            // data: "Fisk",
            success: function (data) {
                //console.log('works');
                location.reload();
            }
        });
    }

    function getRoute(name) {
        console.log("Passed name: " + name);
        var data = eval(wholeModel);
        console.log(data["Viktor"]);
        console.log(JSON.stringify(data[name]));
        model = data[name];
        $("#driverPackages").text(name + ":");
        console.log(data[name][0]);
        for (var i = 0; i < data[name].length; i++) {
            $("#driverPackages").append("<li>" +
                "Content: " +
                data[name][i].Content +
                " Destination: " +
                data[name][i].Destination +
                " Status: " +
                data[name][i].Status +
                "</li>");
        }
        document.getElementById('dropdownMenu2').innerHTML = name + ' <span class="caret"></span>';
        updateMap(transportMethod);
    }
       
</script>
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBMVIteB6a_vtVSunhpk56yZWeTSGN2CkM&callback=initMap">
</script>